"""NVD daily sync service for enriching OSV vulnerabilities with NVD CVSS data.

This service runs once daily (via scheduler) to:
1. Find vulnerabilities that have CVE IDs but missing/outdated NVD data
2. Query NVD API to get authoritative CVSS scores
3. Update vulnerability records with enriched data

Rate limiting is respected - with API key: 50 req/30s, without: 6 req/min.
The sync is designed to be resumable and idempotent.
"""

from datetime import datetime, timedelta, timezone
from typing import Optional

import structlog

from apps.api.services.sbom.vulnerability.nvd_client import NVDClient

logger = structlog.get_logger(__name__)

# Only sync vulnerabilities that haven't been checked in this many hours
NVD_SYNC_INTERVAL_HOURS = 24

# Maximum vulnerabilities to process per sync run (to prevent runaway jobs)
MAX_VULNS_PER_SYNC = 500


class NVDSyncService:
    """Service to sync NVD data for existing vulnerabilities."""

    def __init__(self, db, nvd_api_key: Optional[str] = None):
        """
        Initialize NVD sync service.

        Args:
            db: PyDAL database connection
            nvd_api_key: Optional NVD API key for higher rate limits
        """
        self.db = db
        self.nvd_api_key = nvd_api_key
        self.stats = {
            "processed": 0,
            "updated": 0,
            "skipped": 0,
            "errors": 0,
        }

    async def sync_vulnerabilities(
        self,
        max_vulns: int = MAX_VULNS_PER_SYNC,
        force_refresh: bool = False,
    ) -> dict:
        """
        Sync NVD data for vulnerabilities missing enrichment.

        Args:
            max_vulns: Maximum number of vulnerabilities to process
            force_refresh: If True, refresh all CVEs regardless of last sync time

        Returns:
            Dictionary with sync statistics
        """
        self.stats = {"processed": 0, "updated": 0, "skipped": 0, "errors": 0}

        # Find vulnerabilities needing NVD sync
        vulns_to_sync = self._get_vulns_needing_sync(max_vulns, force_refresh)

        if not vulns_to_sync:
            logger.info("nvd_sync_no_vulns", message="No vulnerabilities need NVD sync")
            return self.stats

        logger.info(
            "nvd_sync_starting",
            vuln_count=len(vulns_to_sync),
            max_vulns=max_vulns,
            force_refresh=force_refresh,
        )

        async with NVDClient(api_key=self.nvd_api_key) as nvd_client:
            for vuln in vulns_to_sync:
                await self._sync_single_vulnerability(nvd_client, vuln)
                self.stats["processed"] += 1

        logger.info(
            "nvd_sync_complete",
            **self.stats,
        )

        return self.stats

    def _get_vulns_needing_sync(
        self, max_vulns: int, force_refresh: bool
    ) -> list:
        """
        Get vulnerabilities that need NVD sync.

        Criteria:
        - Has a CVE ID (starts with 'CVE-')
        - Either:
          - nvd_last_sync is NULL (never synced)
          - nvd_last_sync is older than NVD_SYNC_INTERVAL_HOURS
          - force_refresh is True
        """
        db = self.db
        cutoff_time = datetime.now(timezone.utc) - timedelta(hours=NVD_SYNC_INTERVAL_HOURS)

        # Build query - only get CVEs that need syncing
        query = db.vulnerabilities.cve_id.startswith("CVE-")

        if not force_refresh:
            # Only sync if never synced or sync is stale
            query &= (
                (db.vulnerabilities.nvd_last_sync == None) |  # noqa: E711
                (db.vulnerabilities.nvd_last_sync < cutoff_time)
            )

        vulns = db(query).select(
            db.vulnerabilities.id,
            db.vulnerabilities.cve_id,
            db.vulnerabilities.cvss_score,
            db.vulnerabilities.cvss_vector,
            db.vulnerabilities.nvd_last_sync,
            limitby=(0, max_vulns),
            orderby=db.vulnerabilities.nvd_last_sync,  # Oldest first (NULL sorts first)
        )

        return list(vulns)

    async def _sync_single_vulnerability(self, nvd_client: NVDClient, vuln) -> bool:
        """
        Sync a single vulnerability with NVD data.

        Args:
            nvd_client: NVD API client
            vuln: Vulnerability record to sync

        Returns:
            True if updated, False otherwise
        """
        cve_id = vuln.cve_id

        try:
            # Query NVD for this CVE
            nvd_data = await nvd_client.query_by_cve_id(cve_id)

            update_data = {
                "nvd_last_sync": datetime.now(timezone.utc),
            }

            if nvd_data:
                # Update with NVD data if we got results
                if nvd_data.cvss_score is not None:
                    update_data["cvss_score"] = nvd_data.cvss_score
                if nvd_data.cvss_vector:
                    update_data["cvss_vector"] = nvd_data.cvss_vector
                if nvd_data.severity:
                    update_data["severity"] = nvd_data.severity

                logger.debug(
                    "nvd_sync_vuln_updated",
                    cve_id=cve_id,
                    cvss_score=nvd_data.cvss_score,
                    severity=nvd_data.severity,
                )
                self.stats["updated"] += 1
            else:
                # CVE not found in NVD - still mark as synced to avoid re-querying
                logger.debug("nvd_sync_cve_not_found", cve_id=cve_id)
                self.stats["skipped"] += 1

            # Update the vulnerability record
            self.db(self.db.vulnerabilities.id == vuln.id).update(**update_data)
            self.db.commit()

            return nvd_data is not None

        except Exception as e:
            logger.error(
                "nvd_sync_vuln_error",
                cve_id=cve_id,
                error=str(e),
            )
            self.stats["errors"] += 1
            return False


async def run_nvd_sync(db, nvd_api_key: Optional[str] = None, max_vulns: int = MAX_VULNS_PER_SYNC) -> dict:
    """
    Convenience function to run NVD sync.

    Args:
        db: PyDAL database connection
        nvd_api_key: Optional NVD API key
        max_vulns: Maximum vulnerabilities to process

    Returns:
        Sync statistics dictionary
    """
    service = NVDSyncService(db, nvd_api_key)
    return await service.sync_vulnerabilities(max_vulns=max_vulns)
