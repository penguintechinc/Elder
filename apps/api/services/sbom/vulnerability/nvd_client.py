"""NVD (National Vulnerability Database) API client with rate limiting.

NVD provides authoritative vulnerability data from NIST with:
- Comprehensive CVE database
- CVSS scoring
- CPE (Common Platform Enumeration) matching
- Rate limiting: 6 requests/minute without API key, 50/30s with API key

API Documentation: https://nvd.nist.gov/developers/vulnerabilities
"""

# flake8: noqa: E501


import asyncio
from dataclasses import dataclass
from datetime import datetime
from typing import Optional

import httpx
import structlog

logger = structlog.get_logger(__name__)

NVD_API_BASE = "https://services.nvd.nist.gov/rest/json/cves/2.0"

# Rate limiting configuration
# Without API key: 6 requests per minute (1 request per 10 seconds)
# With API key: 50 requests per 30 seconds (1 request per 0.6 seconds)
DEFAULT_RATE_LIMIT = 6  # requests per minute
DEFAULT_REQUEST_INTERVAL = 10.0  # seconds between requests


@dataclass(slots=True)
class NVDVulnerability:
    """NVD vulnerability data structure."""

    id: str  # CVE-2024-12345
    description: str
    severity: str  # CRITICAL, HIGH, MEDIUM, LOW
    cvss_score: Optional[float]
    cvss_vector: Optional[str]
    cpe_matches: list[str]
    references: list[dict]
    published: str
    modified: str


class RateLimiter:
    """Token bucket rate limiter for API requests."""

    def __init__(self, requests_per_minute: int = DEFAULT_RATE_LIMIT):
        """
        Initialize rate limiter.

        Args:
            requests_per_minute: Maximum requests allowed per minute
        """
        self.requests_per_minute = requests_per_minute
        self.interval = 60.0 / requests_per_minute  # seconds between requests
        self.last_request_time: Optional[datetime] = None
        self.lock = asyncio.Lock()

    async def acquire(self):
        """
        Acquire permission to make a request (blocks until allowed).

        Uses exponential backoff to respect rate limits.
        """
        async with self.lock:
            now = datetime.utcnow()

            if self.last_request_time is not None:
                elapsed = (now - self.last_request_time).total_seconds()
                wait_time = self.interval - elapsed

                if wait_time > 0:
                    logger.debug(
                        "rate_limit_waiting",
                        wait_seconds=wait_time,
                        interval=self.interval,
                    )
                    await asyncio.sleep(wait_time)

            self.last_request_time = datetime.utcnow()


class NVDClient:
    """Client for querying NVD vulnerability database with rate limiting."""

    def __init__(
        self,
        api_key: Optional[str] = None,
        timeout: int = 30,
        requests_per_minute: Optional[int] = None,
    ):
        """
        Initialize NVD client.

        Args:
            api_key: Optional NVD API key (increases rate limit)
            timeout: Request timeout in seconds
            requests_per_minute: Custom rate limit (defaults based on API key presence)
        """
        self.api_key = api_key
        self.timeout = timeout

        # Set rate limit based on API key
        if requests_per_minute is None:
            requests_per_minute = 50 if api_key else DEFAULT_RATE_LIMIT

        self.rate_limiter = RateLimiter(requests_per_minute)

        # Setup HTTP client with API key header if provided
        headers = {}
        if api_key:
            headers["apiKey"] = api_key

        self.client = httpx.AsyncClient(timeout=timeout, headers=headers)

    async def close(self):
        """Close HTTP client."""
        await self.client.aclose()

    async def __aenter__(self):
        """Async context manager entry."""
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """Async context manager exit."""
        await self.close()

    async def query_by_cve_id(self, cve_id: str) -> Optional[NVDVulnerability]:
        """
        Query vulnerability by CVE ID.

        Args:
            cve_id: CVE identifier (e.g., CVE-2024-12345)

        Returns:
            NVDVulnerability object or None if not found

        Example:
            >>> client = NVDClient()
            >>> vuln = await client.query_by_cve_id("CVE-2024-12345")
        """
        try:
            # Respect rate limit
            await self.rate_limiter.acquire()

            params = {"cveId": cve_id}

            logger.debug("nvd_query_by_cve_id", cve_id=cve_id)

            response = await self.client.get(NVD_API_BASE, params=params)
            response.raise_for_status()

            data = response.json()
            vulnerabilities = data.get("vulnerabilities", [])

            if not vulnerabilities:
                logger.debug("nvd_cve_not_found", cve_id=cve_id)
                return None

            # Parse first result
            cve_item = vulnerabilities[0].get("cve", {})
            vuln = self._parse_vulnerability(cve_item)

            logger.info("nvd_query_complete", cve_id=cve_id)
            return vuln

        except httpx.HTTPStatusError as e:
            logger.error(
                "nvd_query_failed",
                cve_id=cve_id,
                status=e.response.status_code,
                error=str(e),
            )
            return None
        except Exception as e:
            logger.error("nvd_query_exception", cve_id=cve_id, error=str(e))
            return None

    async def query_by_cpe(
        self,
        cpe_name: str,
        start_index: int = 0,
        results_per_page: int = 100,
    ) -> list[NVDVulnerability]:
        """
        Query vulnerabilities by CPE (Common Platform Enumeration).

        Args:
            cpe_name: CPE name (e.g., cpe:2.3:a:vendor:product:version:*:*:*:*:*:*:*)
            start_index: Starting index for pagination
            results_per_page: Number of results per page (max 2000)

        Returns:
            List of NVDVulnerability objects

        Example:
            >>> client = NVDClient()
            >>> vulns = await client.query_by_cpe("cpe:2.3:a:pallets:flask:2.0.3")
        """
        try:
            # Respect rate limit
            await self.rate_limiter.acquire()

            params = {
                "cpeName": cpe_name,
                "startIndex": start_index,
                "resultsPerPage": results_per_page,
            }

            logger.debug(
                "nvd_query_by_cpe",
                cpe_name=cpe_name,
                start_index=start_index,
                results_per_page=results_per_page,
            )

            response = await self.client.get(NVD_API_BASE, params=params)
            response.raise_for_status()

            data = response.json()
            vulnerabilities = data.get("vulnerabilities", [])

            results = []
            for item in vulnerabilities:
                cve_item = item.get("cve", {})
                vuln = self._parse_vulnerability(cve_item)
                results.append(vuln)

            logger.info(
                "nvd_cpe_query_complete",
                cpe_name=cpe_name,
                count=len(results),
                total_results=data.get("totalResults", 0),
            )

            return results

        except httpx.HTTPStatusError as e:
            logger.error(
                "nvd_cpe_query_failed",
                cpe_name=cpe_name,
                status=e.response.status_code,
                error=str(e),
            )
            return []
        except Exception as e:
            logger.error("nvd_cpe_query_exception", cpe_name=cpe_name, error=str(e))
            return []

    async def query_by_keyword(
        self,
        keyword: str,
        start_index: int = 0,
        results_per_page: int = 100,
    ) -> list[NVDVulnerability]:
        """
        Query vulnerabilities by keyword search.

        Args:
            keyword: Search keyword (package name, vendor, etc.)
            start_index: Starting index for pagination
            results_per_page: Number of results per page (max 2000)

        Returns:
            List of NVDVulnerability objects

        Example:
            >>> client = NVDClient()
            >>> vulns = await client.query_by_keyword("flask")
        """
        try:
            # Respect rate limit
            await self.rate_limiter.acquire()

            params = {
                "keywordSearch": keyword,
                "startIndex": start_index,
                "resultsPerPage": results_per_page,
            }

            logger.debug(
                "nvd_query_by_keyword",
                keyword=keyword,
                start_index=start_index,
                results_per_page=results_per_page,
            )

            response = await self.client.get(NVD_API_BASE, params=params)
            response.raise_for_status()

            data = response.json()
            vulnerabilities = data.get("vulnerabilities", [])

            results = []
            for item in vulnerabilities:
                cve_item = item.get("cve", {})
                vuln = self._parse_vulnerability(cve_item)
                results.append(vuln)

            logger.info(
                "nvd_keyword_query_complete",
                keyword=keyword,
                count=len(results),
                total_results=data.get("totalResults", 0),
            )

            return results

        except httpx.HTTPStatusError as e:
            logger.error(
                "nvd_keyword_query_failed",
                keyword=keyword,
                status=e.response.status_code,
                error=str(e),
            )
            return []
        except Exception as e:
            logger.error("nvd_keyword_query_exception", keyword=keyword, error=str(e))
            return []

    def _parse_vulnerability(self, cve_data: dict) -> NVDVulnerability:
        """
        Parse NVD API response into NVDVulnerability object.

        Args:
            cve_data: Raw CVE data from NVD API

        Returns:
            Parsed NVDVulnerability object
        """
        cve_id = cve_data.get("id", "UNKNOWN")

        # Extract description
        descriptions = cve_data.get("descriptions", [])
        description = ""
        for desc in descriptions:
            if desc.get("lang") == "en":
                description = desc.get("value", "")
                break

        # Extract CVSS metrics (prefer v3.1, fallback to v3.0, then v2.0)
        severity = "UNKNOWN"
        cvss_score = None
        cvss_vector = None

        metrics = cve_data.get("metrics", {})

        # Try CVSSv3.1
        cvss_v31 = metrics.get("cvssMetricV31", [])
        if cvss_v31:
            cvss_data = cvss_v31[0].get("cvssData", {})
            cvss_score = cvss_data.get("baseScore")
            cvss_vector = cvss_data.get("vectorString")
            severity = cvss_data.get("baseSeverity", "UNKNOWN").upper()

        # Fallback to CVSSv3.0
        if cvss_score is None:
            cvss_v30 = metrics.get("cvssMetricV30", [])
            if cvss_v30:
                cvss_data = cvss_v30[0].get("cvssData", {})
                cvss_score = cvss_data.get("baseScore")
                cvss_vector = cvss_data.get("vectorString")
                severity = cvss_data.get("baseSeverity", "UNKNOWN").upper()

        # Fallback to CVSSv2
        if cvss_score is None:
            cvss_v2 = metrics.get("cvssMetricV2", [])
            if cvss_v2:
                cvss_data = cvss_v2[0].get("cvssData", {})
                cvss_score = cvss_data.get("baseScore")
                cvss_vector = cvss_data.get("vectorString")
                # CVSSv2 doesn't have severity, calculate from score
                if cvss_score >= 7.0:
                    severity = "HIGH"
                elif cvss_score >= 4.0:
                    severity = "MEDIUM"
                else:
                    severity = "LOW"

        # Extract CPE matches
        cpe_matches = []
        configurations = cve_data.get("configurations", [])
        for config in configurations:
            nodes = config.get("nodes", [])
            for node in nodes:
                cpe_match = node.get("cpeMatch", [])
                for match in cpe_match:
                    if match.get("vulnerable", True):
                        cpe_matches.append(match.get("criteria", ""))

        # Extract references
        references = []
        refs = cve_data.get("references", [])
        for ref in refs:
            references.append({"url": ref.get("url"), "source": ref.get("source")})

        # Extract dates
        published = cve_data.get("published", "")
        modified = cve_data.get("lastModified", "")

        return NVDVulnerability(
            id=cve_id,
            description=description,
            severity=severity,
            cvss_score=cvss_score,
            cvss_vector=cvss_vector,
            cpe_matches=cpe_matches,
            references=references,
            published=published,
            modified=modified,
        )
