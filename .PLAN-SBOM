# Elder SBOM & Dependency Tracking Implementation Plan

## Overview

Add comprehensive Software Bill of Materials (SBOM) capabilities to Elder for tracking software dependencies within applications and services. This enables full supply chain visibility, vulnerability correlation, and license compliance tracking.

**Key Decisions:**
- All package ecosystems implemented together (Python, Node.js, Go, Rust, Java, .NET)
- Vulnerability tracking (OSV.dev, NVD) included from Phase 1
- Multiple scan triggers: Manual/API, Auto on service creation, Scheduled periodic scans
- Fully community edition (no license gating)

---

## Database Models

### New Tables (add to `/apps/api/models/pydal_models.py`)

#### 1. `sbom_components` - Core Package/Library Tracking
```
Fields:
- id, tenant_id, village_id (standard)
- parent_type: 'service' | 'software' | 'sbom_component'
- parent_id: polymorphic reference to parent
- name: package name (e.g., "flask", "lodash")
- version: semantic version
- purl: Package URL (pkg:pypi/flask@2.0.0) - standardized identifier
- package_type: 'pypi' | 'npm' | 'go' | 'maven' | 'nuget' | 'cargo' | 'gem'
- scope: 'runtime' | 'dev' | 'optional' | 'test'
- direct: boolean (direct vs transitive dependency)
- license_id: SPDX identifier
- license_name, license_url
- source_file: file it was parsed from
- repository_url, homepage_url, description
- hash_sha256, hash_sha512: integrity hashes
- metadata: JSON for additional data
- is_active, created_at, updated_at
```

#### 2. `sbom_scans` - Scan Job Tracking
```
Fields:
- id, tenant_id, village_id
- parent_type, parent_id: what was scanned
- scan_type: 'git_clone' | 'git_api' | 'manual_upload' | 'sbom_import'
- status: 'pending' | 'running' | 'completed' | 'failed'
- repository_url, repository_branch, commit_hash
- files_scanned: JSON list of dependency files found
- components_found, components_added, components_updated, components_removed
- error_message, scan_duration_ms
- started_at, completed_at, created_at
```

#### 3. `vulnerabilities` - CVE/Vulnerability Database
```
Fields:
- id, tenant_id, village_id
- cve_id: unique (CVE-2024-12345)
- aliases: list (GHSA-xxxx, etc.)
- severity: 'critical' | 'high' | 'medium' | 'low' | 'unknown'
- cvss_score: 0.0-10.0, cvss_vector
- title, description
- affected_packages: JSON [{purl_pattern, version_range}]
- fixed_versions: JSON {purl: [versions]}
- references: list of advisory URLs
- published_at, modified_at
- source: 'nvd' | 'osv' | 'github_advisory' | 'manual'
- is_active, created_at, updated_at
```

#### 4. `component_vulnerabilities` - Component-CVE Links
```
Fields:
- id, tenant_id
- component_id: FK to sbom_components
- vulnerability_id: FK to vulnerabilities
- status: 'open' | 'investigating' | 'false_positive' | 'remediated' | 'accepted'
- remediation_notes, remediated_at, remediated_by_id
- created_at, updated_at
```

#### 5. `license_policies` - License Compliance Rules
```
Fields:
- id, tenant_id, organization_id, village_id
- name, description
- allowed_licenses: list of SPDX IDs
- denied_licenses: list of SPDX IDs
- action: 'warn' | 'block'
- is_active, created_at, updated_at
```

#### 6. `sbom_scan_schedules` - Periodic Scan Configuration
```
Fields:
- id, tenant_id, village_id
- parent_type, parent_id
- schedule_cron: cron expression
- is_active, last_run_at, next_run_at
- created_at, updated_at
```

---

## API Endpoints

### SBOM Component API (`/apps/api/api/v1/sbom.py`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/sbom/components` | List components (filter by parent, type, license) |
| GET | `/api/v1/sbom/components/{id}` | Get component details |
| POST | `/api/v1/sbom/components` | Create component (manual) |
| PUT | `/api/v1/sbom/components/{id}` | Update component |
| DELETE | `/api/v1/sbom/components/{id}` | Delete component |
| GET | `/api/v1/sbom/components/{id}/vulnerabilities` | Get CVEs for component |
| GET | `/api/v1/sbom/components/{id}/tree` | Get dependency tree |

### SBOM Scan API (`/apps/api/api/v1/sbom_scans.py`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/sbom/scans` | List scan history |
| GET | `/api/v1/sbom/scans/{id}` | Get scan details |
| POST | `/api/v1/sbom/scans` | Trigger manual scan |
| POST | `/api/v1/sbom/scans/upload` | Upload SBOM file |
| GET | `/api/v1/sbom/scans/pending` | Get pending scans (for scanner worker) |

### Resource SBOM Extensions
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/services/{id}/sbom` | Get service's SBOM |
| POST | `/api/v1/services/{id}/sbom/scan` | Trigger scan for service |
| GET | `/api/v1/services/{id}/sbom/export` | Export as CycloneDX/SPDX |
| GET | `/api/v1/software/{id}/sbom` | Get software's SBOM |
| POST | `/api/v1/software/{id}/sbom/scan` | Trigger scan for software |

### Vulnerability API (`/apps/api/api/v1/vulnerabilities.py`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/vulnerabilities` | List vulnerabilities |
| GET | `/api/v1/vulnerabilities/{id}` | Get vulnerability details |
| POST | `/api/v1/vulnerabilities/sync` | Sync from OSV/NVD |
| GET | `/api/v1/vulnerabilities/dashboard` | Summary stats |
| PATCH | `/api/v1/component-vulnerabilities/{id}` | Update vuln status |

### License Policy API (`/apps/api/api/v1/license_policies.py`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/license-policies` | List policies |
| POST | `/api/v1/license-policies` | Create policy |
| PUT | `/api/v1/license-policies/{id}` | Update policy |
| DELETE | `/api/v1/license-policies/{id}` | Delete policy |
| POST | `/api/v1/license-policies/check` | Check components against policies |

---

## SBOM Parser Service

### Directory Structure (`/apps/api/services/sbom/`)
```
/apps/api/services/sbom/
├── __init__.py
├── service.py              # Main orchestrator
├── base.py                 # BaseDependencyParser ABC
├── parsers/
│   ├── __init__.py
│   ├── python_parser.py    # requirements.txt, pyproject.toml, Pipfile, setup.py
│   ├── node_parser.py      # package.json, yarn.lock, pnpm-lock.yaml
│   ├── go_parser.py        # go.mod, go.sum
│   ├── rust_parser.py      # Cargo.toml, Cargo.lock
│   ├── java_parser.py      # pom.xml, build.gradle
│   ├── dotnet_parser.py    # *.csproj, packages.config
│   └── sbom_parser.py      # CycloneDX, SPDX import
├── exporters/
│   ├── __init__.py
│   ├── cyclonedx.py        # CycloneDX 1.4+ JSON/XML
│   └── spdx.py             # SPDX 2.3 JSON
└── vulnerability/
    ├── __init__.py
    ├── osv_client.py       # OSV.dev API client
    ├── nvd_client.py       # NVD API client (rate limited)
    └── matcher.py          # Match components to CVEs
```

### Supported Dependency Files
| Ecosystem | Files |
|-----------|-------|
| Python | requirements.txt, requirements-*.txt, pyproject.toml, Pipfile, Pipfile.lock, setup.py, setup.cfg, poetry.lock |
| Node.js | package.json, package-lock.json, yarn.lock, pnpm-lock.yaml |
| Go | go.mod, go.sum |
| Rust | Cargo.toml, Cargo.lock |
| Java | pom.xml, build.gradle, build.gradle.kts, gradle.lockfile |
| .NET | *.csproj, packages.config, Directory.Packages.props, *.fsproj |
| Ruby | Gemfile, Gemfile.lock |

---

## Scanner Worker

### Git Repository Scanner (`/apps/scanner/scanners/sbom_scanner.py`)

Flow:
1. Poll `/api/v1/sbom/scans/pending` for pending scan jobs
2. Clone repository (shallow: `--depth=1`)
3. Find all dependency files recursively
4. Parse each file with appropriate parser
5. Generate PURL for each component
6. Submit results to `/api/v1/sbom/scans/{id}/results`
7. Trigger vulnerability matching

### Auto-Scan Hook

In `/apps/api/api/v1/services.py` `create_service()`:
- If `repository_url` is provided, auto-create scan job
- Scan runs asynchronously via scanner worker

### Scheduled Scans

Add cron job support to scanner worker:
- Query `sbom_scan_schedules` for due scans
- Create scan jobs for each
- Update `last_run_at` and `next_run_at`

---

## Frontend Components

### New Pages
| Page | Route | Description |
|------|-------|-------------|
| SBOMDashboard | `/sbom` | Overview: component count, vuln summary, recent scans |
| ComponentList | `/sbom/components` | Searchable/filterable component list |
| ComponentDetail | `/sbom/components/{id}` | Details, dependencies, vulns |
| VulnerabilityList | `/vulnerabilities` | All CVEs with severity filtering |
| VulnerabilityDetail | `/vulnerabilities/{id}` | CVE details, affected components |
| ScanHistory | `/sbom/scans` | Scan job history and status |
| LicensePolicies | `/license-policies` | Manage compliance policies |

### New Components (`/web/src/components/`)
- `SBOMTree.tsx` - Hierarchical dependency tree (collapsible)
- `DependencyGraph.tsx` - ReactFlow visualization
- `VulnerabilitySeverityBadge.tsx` - Color-coded CVSS badge
- `LicenseBadge.tsx` - License with policy status
- `ScanButton.tsx` - Trigger scan with progress indicator
- `ComponentCard.tsx` - Compact component display
- `VulnerabilityTable.tsx` - Sortable vuln list

### Integration with Existing Pages
- **ServiceDetail.tsx**: Add "Dependencies" tab, "Scan" button, vuln badge
- **SoftwareDetail.tsx**: Add "Components" section, manual entry
- **RelationshipGraph.tsx**: Include `sbom_component` nodes
- **Map.tsx**: Show component dependency chains

---

## Implementation Phases

### Phase 1: Core Foundation
**Files to modify/create:**
- `apps/api/models/pydal_models.py` - Add all 6 new tables
- `apps/api/models/dataclasses.py` - Add DTOs (SBOMComponentDTO, VulnerabilityDTO, etc.)
- `apps/api/api/v1/sbom.py` - Component CRUD endpoints
- `apps/api/api/v1/sbom_scans.py` - Scan management endpoints
- `apps/api/main.py` - Register new blueprints
- `apps/api/services/sbom/` - Create directory structure

**Deliverable:** Manual component entry, basic listing, scan job creation

### Phase 2: Parsers (All Ecosystems)
**Files to create:**
- `apps/api/services/sbom/base.py` - BaseDependencyParser
- `apps/api/services/sbom/parsers/python_parser.py`
- `apps/api/services/sbom/parsers/node_parser.py`
- `apps/api/services/sbom/parsers/go_parser.py`
- `apps/api/services/sbom/parsers/rust_parser.py`
- `apps/api/services/sbom/parsers/java_parser.py`
- `apps/api/services/sbom/parsers/dotnet_parser.py`
- `apps/scanner/scanners/sbom_scanner.py` - Git clone + parse

**Deliverable:** Automated dependency extraction from git repos

### Phase 3: Vulnerability Integration
**Files to create:**
- `apps/api/services/sbom/vulnerability/osv_client.py`
- `apps/api/services/sbom/vulnerability/nvd_client.py`
- `apps/api/services/sbom/vulnerability/matcher.py`
- `apps/api/api/v1/vulnerabilities.py`

**Files to modify:**
- `apps/api/api/v1/sbom.py` - Add vuln endpoints

**Deliverable:** CVE correlation, vulnerability dashboard

### Phase 4: SBOM Import/Export
**Files to create:**
- `apps/api/services/sbom/parsers/sbom_parser.py`
- `apps/api/services/sbom/exporters/cyclonedx.py`
- `apps/api/services/sbom/exporters/spdx.py`

**Deliverable:** CycloneDX 1.4 and SPDX 2.3 support

### Phase 5: Auto & Scheduled Scanning
**Files to modify:**
- `apps/api/api/v1/services.py` - Auto-scan on create/update
- `apps/scanner/main.py` - Add scheduled scan polling

**Deliverable:** Automatic scanning on service creation, cron-based rescans

### Phase 6: License Compliance
**Files to create:**
- `apps/api/api/v1/license_policies.py`

**Deliverable:** License policy management, violation detection

### Phase 7: Frontend
**Files to create (in `/web/src/`):**
- `pages/SBOMDashboard.tsx`
- `pages/ComponentList.tsx`
- `pages/ComponentDetail.tsx`
- `pages/VulnerabilityList.tsx`
- `pages/VulnerabilityDetail.tsx`
- `pages/ScanHistory.tsx`
- `pages/LicensePolicies.tsx`
- `components/SBOMTree.tsx`
- `components/DependencyGraph.tsx`
- `components/VulnerabilitySeverityBadge.tsx`

**Files to modify:**
- `pages/ServiceDetail.tsx` - Add SBOM tab
- `pages/SoftwareDetail.tsx` - Add components section
- `lib/api.ts` - Add SBOM API functions
- `App.tsx` - Add routes

**Deliverable:** Full UI for SBOM management

### Phase 8: Graph Integration
**Files to modify:**
- `apps/api/api/v1/graph.py` - Add sbom_component to valid types
- `web/src/pages/RelationshipGraph.tsx` - Component nodes
- `web/src/components/NetworkGraph.tsx` - Component styling

**Deliverable:** Visual dependency graphs integrated with existing map

---

## Critical Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `apps/api/models/pydal_models.py` | Modify | Add 6 new tables |
| `apps/api/models/dataclasses.py` | Modify | Add DTOs |
| `apps/api/api/v1/sbom.py` | Create | Component API |
| `apps/api/api/v1/sbom_scans.py` | Create | Scan API |
| `apps/api/api/v1/vulnerabilities.py` | Create | Vulnerability API |
| `apps/api/api/v1/license_policies.py` | Create | License policy API |
| `apps/api/api/v1/services.py` | Modify | Add SBOM endpoints, auto-scan |
| `apps/api/api/v1/graph.py` | Modify | Add component support |
| `apps/api/services/sbom/` | Create | Parser service directory |
| `apps/scanner/scanners/sbom_scanner.py` | Create | Git scanner |
| `apps/api/main.py` | Modify | Register blueprints |
| `web/src/lib/api.ts` | Modify | Add API functions |
| `web/src/App.tsx` | Modify | Add routes |

---

## Additional Recommendations

### 1. Package URL (PURL) Standard
Use standardized PURL format throughout:
- `pkg:pypi/flask@2.0.3`
- `pkg:npm/@angular/core@17.0.0`
- `pkg:golang/github.com/gin-gonic/gin@v1.9.1`
- `pkg:maven/org.apache.commons/commons-lang3@3.12.0`

### 2. Vulnerability Data Sources Priority
1. **OSV.dev** (primary) - Free, comprehensive, fast API
2. **GitHub Advisory Database** - Excellent for open-source
3. **NVD** - Authoritative but rate-limited (6 req/min without API key)

### 3. Performance Optimizations
- Shallow git clones (`--depth=1`)
- Redis caching for vulnerability lookups
- Store file hashes to skip unchanged files
- Async parsing with `asyncio.TaskGroup`

### 4. Security Considerations
- Sanitize repository URLs (no embedded credentials)
- Rate limit scan requests per tenant
- Sandbox git clone operations
- Validate uploaded SBOM files (size limits, schema validation)

### 5. Future Enhancements
- SLSA attestation/signing support
- GitHub/GitLab PR integration (comment on PRs with new vulns)
- Dependency update recommendations
- Transitive dependency depth visualization
- Export compliance reports (SOC2, FedRAMP)
