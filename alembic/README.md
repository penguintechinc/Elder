# Elder Database Migrations

This directory contains Alembic database migrations for Elder.

## Prerequisites

- SQLAlchemy 2.0.36+
- Alembic 1.14.0+
- PostgreSQL database

## Running Migrations

### Inside Docker Container

```bash
# Check current migration version
docker-compose exec api bash -c "DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder alembic current"

# Upgrade to latest migration
docker-compose exec api bash -c "DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder alembic upgrade head"

# Downgrade one migration
docker-compose exec api bash -c "DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder alembic downgrade -1"

# Show migration history
docker-compose exec api bash -c "DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder alembic history"
```

### Local Development

```bash
# Set DATABASE_URL environment variable
export DATABASE_URL=postgresql://elder:elder_dev_password@localhost:5432/elder

# Check current version
alembic current

# Upgrade to latest
alembic upgrade head

# Create new migration
alembic revision -m "Description of changes"
```

## Migration Files

Migrations are stored in `alembic/versions/` with the naming convention:
```
YYYYMMDD_HHMM_<revision>_<slug>.py
```

### Existing Migrations

- **001_enterprise**: Add enterprise features (resource roles, issues, metadata)
- **002**: Add is_incident flag to issues table
- **003**: Add alert configurations
- **004**: Add issue_type enum to issues
- **005**: Add default root organization (ensures organization ID 1 exists for UI)

## Creating New Migrations

1. Make changes to SQLAlchemy models in `apps/api/models/`
2. Generate migration:
   ```bash
   docker-compose exec api bash -c "DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder alembic revision --autogenerate -m 'Description'"
   ```
3. Review and edit the generated migration file
4. Test the migration:
   ```bash
   docker-compose exec api bash -c "DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder alembic upgrade head"
   ```

## Migration Best Practices

1. **Always review autogenerated migrations** - Alembic may not catch everything
2. **Test both upgrade and downgrade** - Ensure migrations are reversible
3. **Use transactions** - Keep migrations atomic
4. **Data migrations** - Separate schema and data changes when possible
5. **Idempotency** - Migrations should handle being run multiple times safely

## Troubleshooting

### Connection Issues

If you see connection errors to localhost, make sure to use the DATABASE_URL with the correct hostname:
```bash
DATABASE_URL=postgresql://elder:elder_dev_password@elder-postgres:5432/elder
```

### Revision Chain Errors

If migrations reference incorrect down_revision values, check that the revision chain is correct:
```bash
grep "^revision = \|^down_revision = " alembic/versions/*.py
```

### Missing Models

If Alembic can't find models, ensure all SQLAlchemy models are imported in `alembic/env.py`.
